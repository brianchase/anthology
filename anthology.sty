% Last modified: Sat 06 Jun 2015 01:17:46 PM EDT

% This software is provided 'as is', without warranty of any kind,
% either expressed or implied, including, but not limited to, the
% implied warranties of merchantability and fitness for a particular
% purpose.

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{anthology}

%%%%%%%%%%%%%%%%%%%%%%%
%%  Package Options  %%
%%%%%%%%%%%%%%%%%%%%%%%

\newif\if@ebook
\newif\if@eptfont
\newif\if@letterpaper
\DeclareOption{11pt}{\@eptfonttrue}
\DeclareOption{a4paper}{\@letterpapertrue\@ebookfalse}
\DeclareOption{annotate}{\PassOptionsToPackage{\CurrentOption}{biblatex}}
\DeclareOption{collsonly}{\PassOptionsToPackage{\CurrentOption}{biblatex}}
\DeclareOption{ebook}{\@ebooktrue\@letterpaperfalse\@twocolumnfalse}
\DeclareOption{firstshort}{\PassOptionsToPackage{\CurrentOption}{biblatex}}
\DeclareOption{letterpaper}{\@letterpapertrue\@ebookfalse}
\DeclareOption{reflist}{\PassOptionsToPackage{\CurrentOption}{biblatex}}
\ProcessOptions

%%%%%%%%%%%%%%%%%%%%%%%%
%%  Basic Formatting  %%
%%%%%%%%%%%%%%%%%%%%%%%%

\frenchspacing                % French spacing after punctuation
\setlength{\parindent}{1.1em} % Indent paragraphs by this value
\widowpenalty=1500            % Reduce but don't prohibit widows
\clubpenalty=1000             % Reduce but don't prohibit orphans
\if@twocolumn % Vertical justification if '@twocolumntrue'
  \usepackage{fixltx2e}% Address other issues with two columns
  \flushbottom
\else
  \raggedbottom
\fi

% Use '\sloppy' with options ebook, 10pt, and 12pt:
\if@ebook\sloppy\else\if@eptfont\else\sloppy\fi\fi

% Change 'cleardoublepage' to allow blank pages:
\renewcommand{\cleardoublepage}{%
  \clearpage\thispagestyle{empty}\if@twoside \ifodd\c@page\else
  \hbox{}\newpage\if@twocolumn\hbox{}\newpage\fi\fi\fi}%

% Basic layout for ebooks: Among other things, horizontally center the
% text body. Vertically center the area from the top of the header to
% the bottom of the text body.
\if@ebook
  \setlength\paperheight{8.5in}
  \setlength\paperwidth{5.5in}
  \setlength\evensidemargin{-30pt}
  \setlength\headheight{14pt}
  \setlength\headsep{8pt}
  \setlength\marginparsep{8pt}
  \setlength\marginparwidth{30pt}
  \setlength\oddsidemargin{-30pt}
  \setlength\textheight{38\baselineskip}
  \setlength\textwidth{312pt}
  \setlength\topmargin{-34pt}
\fi

%%%%%%%%%%%%%
%%  Fonts  %%
%%%%%%%%%%%%%

\usepackage{xltxtra,xunicode,fontspec}
\defaultfontfeatures{Ligatures=TeX,Numbers={OldStyle,Proportional}}
\setmainfont[
  Extension=.otf,
  UprightFont=*-regular,
  BoldFont=*-bold,
  ItalicFont=*-italic,
  BoldItalicFont=*-bolditalic]{texgyretermes}
\newfontfamily{\greekfont}[
  Scale=MatchLowercase,
  Extension=.otf,
  UprightFont=*,
  BoldFont=*Bold,
  ItalicFont=*Italic,
  BoldItalicFont=*BoldItalic]{GFSDidot}
\let\lnn\liningnums
\usepackage[greek,american]{babel}
\newcommand{\grk}[1]{{\greekfont\foreignlanguage{greek}{#1}}}
\usepackage{relsize}

%%%%%%%%%%%%%
%%  Notes  %%
%%%%%%%%%%%%%

\usepackage[backend=biber,style=windycity]{biblatex}
\usepackage{csquotes}
\bibliography{anthology}
\usepackage[stable]{footmisc}
\renewcommand{\@makefntext}[1]{%
  \parindent 1em%
  \normalfont\@thefnmark.\hspace{0.4em}#1}%
\newcommand{\source}{%
  \@ifstar
    {\@ifnextchar[{\xfootnote}{\xfootnote[]}}%
    {\@ifnextchar[{\yfootnote}{\yfootnote[]}}}
\def\xfootnote[#1]#2{%
  \nfootnote{Republished~from~\fullcite*[#1]{#2}}}
\def\yfootnote[#1]#2{%
  \nfootnote{Republished~from~\fullcite[#1]{#2}}}
\long\def\nfootnote#1{%
  \insert\footins{\normalfont\footnotesize
  \interlinepenalty\interfootnotelinepenalty
  \splittopskip\footnotesep
  \splitmaxdepth \dp\strutbox \floatingpenalty \@MM
  \hsize\columnwidth \@parboxrestore
  \footnoterule
  {\rule{\z@}{\footnotesep}\ignorespaces
    #1\strut}}}
\setlength{\bibhang}{1.1em}
\defbibheading{bibliography}{%
  \chapter*{Bibliography}
  \addcontentsline{toc}{schapter}{Bibliography}
  \markright{Bibliography}}%
\defbibheading{references}{%
  \chapter*{References}
  \addcontentsline{toc}{schapter}{References}
  \markright{References}}%
\usepackage{marginnote}
\renewcommand{\marginfont}{\normalfont\small}%

%%%%%%%%%%%%%%%%%%
%%  Title Page  %%
%%%%%%%%%%%%%%%%%%

\renewcommand{\maketitle}{%
  \begin{titlepage}
    \leavevmode\vfil
    \begin{center}
      {\Huge\itshape\@title}%
    \end{center}
    \vfil\vfil\leavevmode
    \clearpage
  \end{titlepage}}%

%%%%%%%%%%%%%%%%%%%%%%%%%
%%  Table of Contents  %%
%%%%%%%%%%%%%%%%%%%%%%%%%

\setcounter{tocdepth}{0}
\renewcommand{\tableofcontents}{%
  \cleardoublepage
  \if@twocolumn
    \@restonecoltrue\onecolumn
  \else
    \@restonecolfalse
  \fi
  \chapter*{\contentsname
    \@mkboth{\itshape\contentsname}{\itshape\contentsname}}%
  \@starttoc{toc}%
  \if@restonecol\twocolumn\fi}%
\renewcommand*{\l@chapter}[2]{%
  \ifnum \c@tocdepth >\m@ne
    \addpenalty{-\@highpenalty}%
    \vskip 1ex \@plus\p@
    \setlength\@tempdima{1.6em}%
    \begingroup
      \parindent \z@ \rightskip \@pnumwidth
      \parfillskip -\@pnumwidth
      \leavevmode
      \advance\leftskip\@tempdima
      \hskip -\leftskip
      \hangindent=1.1em\hangafter=1{#1\nobreak\hfil
      \nobreak\hb@xt@\@pnumwidth{\hss #2}}\par
      \penalty\@highpenalty
    \endgroup
  \fi}%
\newcommand*{\l@schapter}[2]{%
  \ifnum \c@tocdepth >\m@ne
    \addpenalty{-\@highpenalty}%
    \setlength\@tempdima{1.6em}%
    \begingroup
      \parindent \z@ \rightskip \@pnumwidth
      \parfillskip -\@pnumwidth
      \leavevmode \itshape
      \advance\leftskip\@tempdima
      \hskip -\leftskip
      #1\nobreak\hfil \nobreak\hb@xt@\@pnumwidth{\hss #2}\par
      \penalty\@highpenalty
    \endgroup
  \fi}%
\def\@chapter[#1]#2{%
  \ifnum \c@secnumdepth >\m@ne
    \if@mainmatter
      \refstepcounter{chapter}%
      \typeout{\@chapapp\space\thechapter.}%
      \ifdefempty{\@author}
        {\addcontentsline{toc}{chapter}{%
           \protect\numberline{\thechapter}#1}}%
        {\addcontentsline{toc}{chapter}{%
           \protect\numberline{\thechapter}#1\\
           \itshape\@author}}%
    \else
      \addcontentsline{toc}{schapter}{#1}%
    \fi
  \else
    \addcontentsline{toc}{chapter}{#1}%
  \fi
  \chaptermark{#1}%
  \addtocontents{lof}{\protect\addvspace{10\p@}}%
  \addtocontents{lot}{\protect\addvspace{10\p@}}%
  \if@twocolumn
    \@topnewpage[\@makechapterhead{#2}]%
  \else
    \@makechapterhead{#2}%
    \@afterheading
  \fi}%
\renewcommand{\backmatter}{%
  \if@openright
    \cleardoublepage
  \else
    \clearpage
  \fi
  \@mainmatterfalse
  \addtocontents{toc}{\vskip 1.0em}}%

%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%  Headers and Footers  %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%

\usepackage{fancyhdr}
\pagestyle{fancy}
\renewcommand{\chaptermark}[1]{\markboth{\textit{#1}}{}}
\fancyhf{}
\fancyhead[LE,RO]{\thepage}
\fancyhead[CO]{\leftmark}
\fancyhead[CE]{\itshape\@title}
\renewcommand{\headrulewidth}{0pt}
\renewcommand{\footrulewidth}{0pt}

%%%%%%%%%%%%%%%%
%%  Headings  %%
%%%%%%%%%%%%%%%%

\renewcommand{\@makechapterhead}[1]{{%
  \thispagestyle{empty}
  \begin{center}
    {\addfontfeature{Numbers=Lining}\huge\thechapter}%
    \par\nobreak
    \vspace*{10pt}%
    {\LARGE\itshape #1\par\@addon\par\normalfont\large\@textdate}%
    \vskip 1.6em
    {\large\@author\par\normalfont\normalsize\@authdate}%
    \gdef\@textdate{}%
    \gdef\@author{}%
    \gdef\@authdate{}%
    \gdef\@addon{}%
  \end{center}
  \vskip 34pt
  \parindent 0pt}}%
\setcounter{secnumdepth}{5} % Allow numbered paragraphs
\renewcommand{\@schapter}[1]{%
  \chaptermark{#1}% only difference from default
  \if@twocolumn
    \@topnewpage[\@makeschapterhead{#1}]%
  \else
    \@makeschapterhead{#1}%
    \@afterheading
  \fi}%
\renewcommand{\@makeschapterhead}[1]{{%
  \thispagestyle{empty}%
  \begin{center}
    \LARGE\itshape #1\nobreak
  \end{center}
  \vskip 34pt
  \parindent 0pt}}%
\renewcommand{\thesubsubsection}{%
  \normalfont\normalsize\thesubsection.\@arabic\c@subsubsection}%
\renewcommand{\section}{\@startsection{section}{1}{\z@}%
  {-3.5ex \@plus -1ex \@minus -.2ex}%
  {2.3ex \@plus.2ex}%
  {\centering\normalfont\bfseries}}%
\renewcommand{\subsection}{\@startsection{subsection}{2}{\z@}%
  {-3.5ex\@plus -1ex \@minus -.2ex}%
  {1.5ex \@plus .2ex}%
  {\centering\normalfont\itshape}}%
\renewcommand{\subsubsection}{\@startsection{subsubsection}{3}{\z@}%
  {-3.5ex\@plus -1ex \@minus -.2ex}%
  {1.5ex \@plus .2ex}%
  {\centering\normalfont\itshape}}%
\renewcommand{\paragraph}{\@startsection{paragraph}{4}{\z@}%
  {3.5ex \@plus1ex \@minus.2ex}%
  {-0.5em}%
  {\normalfont\small\MakeUppercase}}%
\renewcommand{\subparagraph}{\@startsection{subparagraph}{5}{\parindent}%
  {3.5ex \@plus1ex \@minus .2ex}%
  {-0.5em}%
  {\normalfont\normalsize\itshape}}%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%  Original Source Page Breaks  %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% The command below is from marginnote.sty. Adding '\nobreak' prevents
% a page break between '\marginnote' and the text that follows it.
\renewcommand{\mn@vlap}[1]{%
  \setbox\@tempboxa\vbox to \ht\strutbox{#1\vss}%
  \box\@tempboxa\nobreak\vskip-\baselineskip}%
\newcommand{\page}[1]{%
  \renewcommand{\mypage}{#1}%
  \futurelet\mytoken\pageparse}%
\newcommand{\mypage}{}%
\newcommand{\pageparse}{%
  \ifx\mytoken\section\pagew\else\pagex\fi}%
\newcommand{\pagew}{%
  \if@nobreak
    \marginnote{\mypage}%
  \else
    \vspace{\sectionskip}%
    \marginnote{\mypage}\nobreak
  \fi
  \@afterindentfalse\@afterheading}%
\newlength{\sectionskip}%
\setlength{\sectionskip}{3.5ex \@plus 1ex \@minus .2ex}
\newcommand{\pagex}{%
  \ifx\mytoken\begin\pagey\else\pagez\fi}%
\newcommand{\pagey}{%
  \if@nobreak\else
    \vspace{\partopsep}%
    \vspace{\topsep}%
  \fi
  \marginnote{\mypage}\nobreak
  \@afterindentfalse\@afterheading}%
\newcommand{\pagez}{%
  \ifvmode
    \if@nobreak
      \marginnote{\mypage}\nobreak
      \@afterindentfalse\@afterheading
    \else
      \ifthenelse{\equal{verse}{\@currenvir}}
        {\marginnote{\mypage}[6.4pt]}%
        {\marginnote{\mypage}}%
      \nobreak
    \fi
  \else
    \unskip
    \cleaders\copy\brkbox\hskip\wd\brkbox
    \marginnote{\mypage}\ignorespaces
  \fi}%
\newsavebox{\brkbox}%
\sbox{\brkbox}{$\,|\,$}%

%%%%%%%%%%%%%%%%%%%%%%%%
%%  Fields and Links  %%
%%%%%%%%%%%%%%%%%%%%%%%%

\newcommand{\authdate}[1]{\gdef\@authdate{(#1)}}%
\newcommand{\textdate}[1]{\gdef\@textdate{(#1)}}%
\newcommand{\version}[1]{\gdef\@version{\lnn{#1}}}%
\gdef\@author{}%
\gdef\@authdate{}%
\gdef\@textdate{}%
\gdef\@version{}%
\newcommand{\addon}{\@ifnextchar[{\xaddon}{\xaddon[]}}%
\def\xaddon[#1]#2{\gdef\@addon{\Large#2\par\large#1}}%
\gdef\@addon{}%
\renewcommand{\title}[1]{%
  \gdef\@title{#1}%
  \hypersetup{pdftitle=\@title}}%
\newcommand{\printversion}{%
  \begin{center}
    {\small\emph{\@title}\\version \@version}%
  \end{center}}%

%%%%%%%%%%%%%%%%%%%%%
%%  Miscellaneous  %%
%%%%%%%%%%%%%%%%%%%%%

\usepackage{enumitem}% For lists
\usepackage{graphicx}% For images
\usepackage{multicol}% For multi-column text
\usepackage{wrapfig}% For inset text and figures
\usepackage{verse}% Handy for longer poems

\renewcommand{\@makefnmark}{%
  \hbox{\@textsuperscript{\addfontfeature{Numbers=Lining}\@thefnmark}}}
\newcommand{\BCE}{\textsmaller{BCE}}%
\newcommand{\CE}{\textsmaller{CE}}%
\newcommand{\llb}{\if@eptfont\if@letterpaper\linebreak[4]\fi\fi}%
\newcommand{\wrapadj}{\raggedright\hspace{1em}}
\newenvironment{abstract}[1][]
  {\begin{center}\textsc{#1}\end{center}\small}%
  {}%
\newcommand{\attrib}[1]{%
  \nopagebreak{\hfil\hfil\small\textsc{#1}\medskip}}%

\AtBeginEnvironment{description}{\small}
\AtBeginEnvironment{quotation}{\small}
\AtBeginEnvironment{quote}{\small}
\AtBeginEnvironment{tabular}{\small}
\AtBeginEnvironment{verse}{\small}
\AtBeginEnvironment{wrapfigure}{\footnotesize\itshape}

\setlist{noitemsep}
\newcommand{\addcolon}[1]{#1:}%
\setlist[description]{font=\bfseries,format=\addcolon}
\setlength{\beforepoemtitleskip}{0em}
\renewcommand{\poemtitlefont}{\scshape\centering}%
\setlength{\vgap}{\parindent}
\setlength{\vleftskip}{\parindent}
\hyphenation{mor-als Hough-ton Wil-liam}% for citations

% Pass 'width=\maxwidth' to includegraphics:
\newcommand{\maxwidth}{%
  \ifdim\Gin@nat@width>\columnwidth \columnwidth
  \else\Gin@nat@width\fi}%

\usepackage[%
  anchorcolor=black,
  breaklinks=true,
  citecolor=black,
  colorlinks=true,
  linkcolor=black,
  unicode,
  urlcolor=black]{hyperref}
\urlstyle{same}% Put urls in normal font. Must not precede hyperref.

\endinput
